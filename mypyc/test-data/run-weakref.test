# Test cases for weakrefs (compile and run)

[case testWeakrefRef]
from weakref import ref
from mypy_extensions import mypyc_attr

@mypyc_attr(native_class=False)
class Object:
    """some random weakreffable object"""

def test_weakref_ref():
    obj = Object()
    r = ref(obj)
    assert r() is obj
    obj = None
    assert r() is None, r()

[file driver.py]
from native import test_weakref_ref

test_weakref_ref()


[case testWeakrefRefWithCallback]
from weakref import ref
from mypy_extensions import mypyc_attr

@mypyc_attr(native_class=False)
class Object:
    """some random weakreffable object"""

def test_weakref_ref_with_callback():
    obj = Object()
    r = ref(obj, lambda x: x)
    assert r() is obj
    obj = None
    assert r() is None, r()

[file driver.py]
from native import test_weakref_ref_with_callback

test_weakref_ref_with_callback()


[case testWeakrefProxy]
import pytest  # type: ignore [import-not-found]
from weakref import proxy
from mypy_extensions import mypyc_attr

@mypyc_attr(native_class=False)
class Object:
    """some random weakreffable object"""
    def some_meth(self) -> int:
        return 1

def test_weakref_proxy():
    obj = Object()
    p = proxy(obj)
    assert obj.some_meth() == 1
    assert p.some_meth() == 1
    obj = None
    with pytest.raises(ReferenceError):
        p.some_meth()

[file driver.py]
from native import test_weakref_proxy

test_weakref_proxy()


[case testWeakrefProxyWithCallback]
import pytest  # type: ignore [import-not-found]
from weakref import proxy
from mypy_extensions import mypyc_attr

@mypyc_attr(native_class=False)
class Object:
    """some random weakreffable object"""
    def some_meth(self) -> int:
        return 1

def test_weakref_proxy_with_callback():
    obj = Object()
    p = proxy(obj, lambda x: x)
    assert obj.some_meth() == 1
    assert p.some_meth() == 1
    obj = None
    with pytest.raises(ReferenceError):
        p.some_meth()

[file driver.py]
from native import test_weakref_proxy_with_callback

test_weakref_proxy_with_callback()
